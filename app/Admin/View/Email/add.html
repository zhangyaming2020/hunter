<!--添加管理员-->
<div class="dialog_content">
	<div id="tabs">
		<form id="info_form" name="info_form" action="{:U('project/edit')}" method="post">
			<input type="hidden" name="custom_id" id="prtaCustId" value="{$info.custom_id}">
			<input type="hidden" name="prtaContactIds" id="prtaContactIds" value="{$info.prtacontactids}">
			<input type="hidden" name="id"  value="{$info.id}">
			<input type="hidden" name="type_id" id="type_id"  value="{$type_id}">
			<input type="hidden" name="type" id="type"  value="{$type}">
			<div id="tabs-1">
				<div style="padding:10px;">
						<button type="button" class="button button_blue" state="1" id="emailSend">立即发送</button>
						<!--<button type="button" class="button button_white" state="0" id="emailTranspond">存为草稿</button>-->
						<span id="J_mail_test_tip"></span>
						<span>&nbsp;&nbsp;提示：多个收件人之间以半角“;”号相隔</span>
				</div>
				<div class="form_default" style="padding:0; height:458px; OVERFLOW-Y: auto; BORDER: #ccc 1px solid;">
					
					<p>
						<label for="receiveAddress">收件人</label>
						<textarea name="receiveAddress" id="receiveAddress" style="width:740px; height:30px;" class="mf"></textarea>
					</p>
					<p>
						<label for="title">主题</label>
						<input type="text" name="title" id="title" class="sf" style="width:740px;" value="">
					</p>
					<p>
						<label for="emailFile">附件</label>
						<div class="ke-inline-block ">
							<span class="ke-button-common"><input type="button" id="file" class="file ke-button-common ke-button" value="添加附件"></span>
								</div><input type="button" id="uploadEmailFile" value="添加附件" style="display: none;"><span id="uploadEmailFileState" style="margin-left:10px;"></span>
					</p>
					<p>
						<label for="location">内容</label>
						<div class="ke-container ke-container-default" style="width: 740px;">
						<textarea name="info" class="info" style="width:740px;height:200px;visibility:hidden;resize:none;">{:code2html($info['info'])}</textarea>
                
						</div>
						
					</p>
				</div>
	
			</div>
		</form>
	</div>
</div>
<form style="display:none">
        <input type="file" id="img" name="file">
</form>
<script type="text/javascript">
var editor;  //全局变量
$(function() {
	editor =KindEditor.create('.info', {
		uploadJson : '{:U("attachment/editer_upload")}',
		fileManagerJson : '{:U("attachment/editer_manager")}',
		allowFileManager : true,
		 items : [
                    'fontname', 'fontsize', '|', 'forecolor', 'hilitecolor', 'bold', 'italic', 'underline',
                    'removeformat', '|', 'justifyleft', 'justifycenter', 'justifyright', 'insertorderedlist',
                    'insertunorderedlist', '|', 'emoticons', 'image', 'link','fullscreen']

	});
	
	$('#emailSend').click(function(){
        var email = $('#receiveAddress').val();
        var title = $('#title').val();
        var msg='';
        var attach=$('#uploadEmailFileState').html();
        var info=editor.html();
        var type_id=$("#type_id").val();
        var type=$("#type").val();
        if(title==''){
        	msg='主题不能为空';
        }
        if(email==''){
        	msg='收件人不能为空';
        }
        if(info==''){
        	msg='邮件内容不能为空';
        }
        if(msg){
            $('#J_mail_test_tip').addClass('red').html(msg);
            return false;
        }
        $.post("{:U('email/ajax_mail_send')}", {type:type,type_id:type_id,email:email,'title':title,'info':info,'attach':attach}, function(result){
            if(result.status == 1){
                $('#J_mail_test_tip').removeClass('red').addClass('green').html('邮件发送成功');
                setTimeout(function(){
                	$('#J_mail_test_tip').removeClass('green').html('');
                },1000)
            }else{
                $('#J_mail_test_tip').addClass('red').html('邮件发送失败,请检查数据格式或联系管理员');
            }
        });
    });
    
});
 //上传
$('#file').click(function(){
	$('input[name=file]').click();
})

 $("input[name=file]").change(function(){
    var fd = new FormData();
    fd.append("img", $("input[name=file]").get(0).files[0]);
		$.ajax({
			url: "{:U('email/attachment')}",
			type: "POST",
			processData: false,
			contentType: false,
			data: fd,
			success: function(result) { 
				alert(result['msg']);
				if(result['status']==1){
					$('#uploadEmailFileState').html(result['data']);
					
				}
			}
		});
})
</script>